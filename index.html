<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Ultimate GUI 更新日志生成器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f9fafb; color: #1f2937; padding: 20px; }
    .container { max-width: 800px; margin: auto; }
    h2 { color: #10b981; }
    input, button { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9em; }
    button { background-color: #10b981; color: white; cursor: pointer; }
    #output, #mdOutput { background: #f3f4f6; padding: 15px; border: 1px solid #d1d5db; border-radius: 6px; margin-top: 10px; white-space: pre-wrap; }
    img.preview { max-width: 200px; margin-top: 10px; border: 1px solid #ccc; border-radius: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>📦 更新日志生成器（增强版）</h2>
    
    <label>上传 .zip 文件：</label>
    <input type="file" id="zipInput" accept=".zip">

    <label>版本号：</label>
    <input type="text" id="versionInput" placeholder="例如：v0.1.2">

    <label>修订编号：</label>
    <input type="number" id="uploadCount" value="1" min="1">

    <button onclick="processZip()">📂 分析并生成日志</button>

    <h3>🧾 更新日志：</h3>
    <div id="output">(内容显示在此)</div>

    <h3>📘 Markdown 格式：</h3>
    <div id="mdOutput">(Markdown显示在此)</div>

    <h3>🖼️ 文件预览：</h3>
    <div id="imagePreview"></div>
  </div>

  <script>
    async function processZip() {
      const zipFile = document.getElementById('zipInput').files[0];
      if (!zipFile) return;

      const version = document.getElementById('versionInput').value.trim();
      const count = document.getElementById('uploadCount').value;
      const today = new Date().toISOString().split("T")[0];

      const reader = new FileReader();
      reader.onload = async function (e) {
        const zip = await JSZip.loadAsync(e.target.result);
        const fileList = Object.keys(zip.files);

        // 🔍 缓存对比
        const previousFiles = JSON.parse(localStorage.getItem("prevZipFiles")) || [];
        const added = fileList.filter(f => !previousFiles.includes(f));
        const removed = previousFiles.filter(f => !fileList.includes(f));
        localStorage.setItem("prevZipFiles", JSON.stringify(fileList));

        // 📝 日志生成
        const log = `📌 更新日志（${today})
- 📁 文件名：${zipFile.name}
- 🛠 版本号：${version}
- 🧬 修订编号：第 ${count} 次修订
- 📂 文件数：${fileList.length}
- ➕ 新增文件数：${added.length}
- ➖ 移除文件数：${removed.length}
- 🖼️ 可视化纹理：以下展示部分 PNG 文件
`;
        document.getElementById("output").innerText = log;

        const markdown = `## 📌 更新日志（${today})
**文件名**：\`${zipFile.name}\`  
**版本号**：\`${version}\`  
**修订编号**：第 ${count} 次修订  
**新增文件**：${added.map(f => `- ${f}`).join('\n')}  
**移除文件**：${removed.map(f => `- ${f}`).join('\n')}
`;
        document.getElementById("mdOutput").innerText = markdown;

        // 🖼️ 图片预览（PNG）
        const previewDiv = document.getElementById("imagePreview");
        previewDiv.innerHTML = "";
        for (const fileName of fileList.filter(f => f.endsWith(".png")).slice(0, 3)) {
          const content = await zip.file(fileName).async("base64");
          const img = document.createElement("img");
          img.src = `data:image/png;base64,${content}`;
          img.alt = fileName;
          img.className = "preview";
          previewDiv.appendChild(img);
        }
      };
      reader.readAsArrayBuffer(zipFile);
    }
  </script>
</body>
</html>
